<?php

$city_source = (isset($_POST['city_source'])) ? $_POST['city_source'] : 'destination';
$keyword = (isset($_POST['keyword'])) ? trim($_POST['keyword']) : trim($_GET['query']);
$url = "https://www.jne.co.id/ajax/".$city_source."?query=".$keyword;


get_data($url,$keyword);

function get_data($url,$keyword)
{
	$curl = curl_init();

	curl_setopt_array($curl, array(
	  CURLOPT_URL => $url,
	  CURLOPT_RETURNTRANSFER => true,
	  CURLOPT_ENCODING => "",
	  CURLOPT_MAXREDIRS => 10,
	  CURLOPT_TIMEOUT => 30,
	  CURLOPT_HTTP_VERSION => CURL_HTTP_VERSION_1_1,
	  CURLOPT_SSL_VERIFYPEER => false,
	  CURLOPT_CUSTOMREQUEST => "GET",
	  CURLOPT_HTTPHEADER => array(
		"Accept: text/plain, */*; q=0.01",
		"Accept-Encoding: gzip, deflate, br",
		"Accept-Language: en-US,en;q=0.5",
		"Cache-Control: no-cache",
		"Connection: keep-alive",
		"Cookie: laravel_session=eyJpdiI6IjdYa3RpZ2tPejdKRzhwOEQxbjJTUVE9PSIsInZhbHVlIjoiVm1lMENwR1g5cVFRVmFjNDlGUFNPcEtKcDQzYUlnUUZ0Z1dQSE93THVaaTE5VlwvaWhcLzNadlk1OG83dWdNNE1pVVMwNTY2ek1Xekk4QlhDdHRFOHY2dz09IiwibWFjIjoiNTdiYjUxYWQyZWQxNGZiMWNhMTg4MjA1ZTM5MjBiNDMwZjg4ZDc5MGViNzJlNGU2NTIxNmQ2ZTNmZDcxNmY5NyJ9; f26506104d223be6b1eb1c3fd05c58031d3dacc6=eyJpdiI6IjlaNDh3Vnl5VW9RSGdiclhLdml0bWc9PSIsInZhbHVlIjoiejFWTk9cLzZNUERMNWxGcW5HeHlcL1p5ekxHNnpCXC9iY21wM3BURkVXWUlcL3hadTVPTXZNNTVNQUVtT1Q4dmplU1BHQVo1clpoQit2U2VjMXpkXC9kT0t6aGVcL01RQ0hlZVUzRzFRWGlkZ3hiMG40NE44YzBXTDdEWVZ6NDNhM1A2cHRhSEJDd0c4cjlPSVdwckJQUnBiYTBPY2FtSlwvdTNKMmNBcWJRd2tmcjVvdXNmSUJNK2dNYXpFN0hxV0hGOTN5ZXZiQzg5WkdJNG02NlpmaDBmMGtBbDNRSGZMdHJLajBSdUtXSGNEOFFiQ0RzbVhDV2hIVTdZQlE3U2dSNndNdTlWMElpNmg5Q0Q1UStwWW9ZVU16XC9YbU9RSTAyTHc4cVFLWVUxM2pSU2R6N05FZXZMejMzeGVYZTFKY2YxYXBCd1RxZUlqcEpZdXpzN2IxQ3Zaa1RxaW54SDFcL08xZVJIc3pvTWFwVG1aNGlnQkdMdFRjNG1oYm9HZ1dLViszWFg1SDZZTEFRdU9xaW1MTXozbWJIRE5UakJKMUV2NlZ3QktIZ3grV2pNS3MwWFdGcSswOEpMaWt6YkZpTE96enBKQ0RvTHFTSUp1N1BvUm9KUE5qQW5yM010Z0ZtYTZwQk15VUlmUGp0Z2JMY0RUaDlPS0M1K1diY3BDTk9KRTZXdVhTTGhjZnJlZWt2bXErSkFuNjRPamg1MXBlTFhLWUptWlZvZVBxQ2tYR0JjXC9HY1RYRUZkYnEwN0lPNkNxRjkzYjE1TUlocjJ0dUgxYWEwc1VcL1dXWDV6XC9UOVlNdGZRdFAzQlFFa1krM2NaQldJV1pCWURaSHZZN0hTMGcwS0k0RW5PVXdOWXEyZGhVSmpueXJVbHBnQkdCUDV6NWVGTmE5ZU5GWHhPa0VQeldxeUpSZ28zUG9wM0txTHZZUEFuRjhWOWVDaU9uQVVkN2k0Nm9DYWRrN1NGV0ljVEJBOXBJM3cxY3djd1wvV05qODFpMHRmUmdtZU5RN1RxdWllb004d3BNVlpmM3hpcXpJWVE5WVVTWkVUYUo5emxlaG5XSFVhNGFQUGtRbGJLNGRCdGN3eWU5VWJJeHZ4TDEzZnNVNlFvSzBBZDA4dGpsWnBYV05zVTh4anh3PT0iLCJtYWMiOiJkMGFjYmQ4MmFmOTBkODJjMmFjNjEzZDJiNzUzZjJhZWU0ZGY1NDY3MDRmNTUxZWU3NjliODFhZDQxMjQ0Y2U0In0%3D; _ga=GA1.3.1962766535.1571650064; _gid=GA1.3.1836109405.1571650064; PHPSESSID=kucoa6ad6ehk8av9rm1l4tna25; XSRF-TOKEN=eyJpdiI6ImhSeldFczRMOXRFUURqaWVMcnZqb1E9PSIsInZhbHVlIjoiYUFvWXNuWGJGcW9JVGtcL3RnQ2NJTFlxMTFmZ0NnUXF0NWR4Y2hDVGlKXC9ZTmpMbGZEZ2IxZVBmRDJ0WVBMUlZjMUpJalcyVnJCSWJJaVNhS0pFczZxQT09IiwibWFjIjoiOWUyMTQ5Nzk0OTA0MjYwODdiYTg0NDM5OTc1NjhmYjhhYmRjYzUzNzQ5NmYxZmU0MGMxM2JiMzcwMTQ2MWUzOCJ9; _gat=1, laravel_session=eyJpdiI6IjdYa3RpZ2tPejdKRzhwOEQxbjJTUVE9PSIsInZhbHVlIjoiVm1lMENwR1g5cVFRVmFjNDlGUFNPcEtKcDQzYUlnUUZ0Z1dQSE93THVaaTE5VlwvaWhcLzNadlk1OG83dWdNNE1pVVMwNTY2ek1Xekk4QlhDdHRFOHY2dz09IiwibWFjIjoiNTdiYjUxYWQyZWQxNGZiMWNhMTg4MjA1ZTM5MjBiNDMwZjg4ZDc5MGViNzJlNGU2NTIxNmQ2ZTNmZDcxNmY5NyJ9; f26506104d223be6b1eb1c3fd05c58031d3dacc6=eyJpdiI6IjlaNDh3Vnl5VW9RSGdiclhLdml0bWc9PSIsInZhbHVlIjoiejFWTk9cLzZNUERMNWxGcW5HeHlcL1p5ekxHNnpCXC9iY21wM3BURkVXWUlcL3hadTVPTXZNNTVNQUVtT1Q4dmplU1BHQVo1clpoQit2U2VjMXpkXC9kT0t6aGVcL01RQ0hlZVUzRzFRWGlkZ3hiMG40NE44YzBXTDdEWVZ6NDNhM1A2cHRhSEJDd0c4cjlPSVdwckJQUnBiYTBPY2FtSlwvdTNKMmNBcWJRd2tmcjVvdXNmSUJNK2dNYXpFN0hxV0hGOTN5ZXZiQzg5WkdJNG02NlpmaDBmMGtBbDNRSGZMdHJLajBSdUtXSGNEOFFiQ0RzbVhDV2hIVTdZQlE3U2dSNndNdTlWMElpNmg5Q0Q1UStwWW9ZVU16XC9YbU9RSTAyTHc4cVFLWVUxM2pSU2R6N05FZXZMejMzeGVYZTFKY2YxYXBCd1RxZUlqcEpZdXpzN2IxQ3Zaa1RxaW54SDFcL08xZVJIc3pvTWFwVG1aNGlnQkdMdFRjNG1oYm9HZ1dLViszWFg1SDZZTEFRdU9xaW1MTXozbWJIRE5UakJKMUV2NlZ3QktIZ3grV2pNS3MwWFdGcSswOEpMaWt6YkZpTE96enBKQ0RvTHFTSUp1N1BvUm9KUE5qQW5yM010Z0ZtYTZwQk15VUlmUGp0Z2JMY0RUaDlPS0M1K1diY3BDTk9KRTZXdVhTTGhjZnJlZWt2bXErSkFuNjRPamg1MXBlTFhLWUptWlZvZVBxQ2tYR0JjXC9HY1RYRUZkYnEwN0lPNkNxRjkzYjE1TUlocjJ0dUgxYWEwc1VcL1dXWDV6XC9UOVlNdGZRdFAzQlFFa1krM2NaQldJV1pCWURaSHZZN0hTMGcwS0k0RW5PVXdOWXEyZGhVSmpueXJVbHBnQkdCUDV6NWVGTmE5ZU5GWHhPa0VQeldxeUpSZ28zUG9wM0txTHZZUEFuRjhWOWVDaU9uQVVkN2k0Nm9DYWRrN1NGV0ljVEJBOXBJM3cxY3djd1wvV05qODFpMHRmUmdtZU5RN1RxdWllb004d3BNVlpmM3hpcXpJWVE5WVVTWkVUYUo5emxlaG5XSFVhNGFQUGtRbGJLNGRCdGN3eWU5VWJJeHZ4TDEzZnNVNlFvSzBBZDA4dGpsWnBYV05zVTh4anh3PT0iLCJtYWMiOiJkMGFjYmQ4MmFmOTBkODJjMmFjNjEzZDJiNzUzZjJhZWU0ZGY1NDY3MDRmNTUxZWU3NjliODFhZDQxMjQ0Y2U0In0%3D; _ga=GA1.3.1962766535.1571650064; _gid=GA1.3.1836109405.1571650064; PHPSESSID=kucoa6ad6ehk8av9rm1l4tna25; XSRF-TOKEN=eyJpdiI6ImhSeldFczRMOXRFUURqaWVMcnZqb1E9PSIsInZhbHVlIjoiYUFvWXNuWGJGcW9JVGtcL3RnQ2NJTFlxMTFmZ0NnUXF0NWR4Y2hDVGlKXC9ZTmpMbGZEZ2IxZVBmRDJ0WVBMUlZjMUpJalcyVnJCSWJJaVNhS0pFczZxQT09IiwibWFjIjoiOWUyMTQ5Nzk0OTA0MjYwODdiYTg0NDM5OTc1NjhmYjhhYmRjYzUzNzQ5NmYxZmU0MGMxM2JiMzcwMTQ2MWUzOCJ9; _gat=1; laravel_session=eyJpdiI6Ikhta2pWUEFMQ1lnbGpHM0RVQ1BZVVE9PSIsInZhbHVlIjoiR3M5Mk9WVE1lcVNQcFBpWDduY09hbG9CZ1hwRmdOTnhaR1wvMTM1cWJzYnpkNkhRMWhjZXo4REZncXBScGNjeUw2TlwvWWZPZVV0Y2pYbTBPSDZkNFp3dz09IiwibWFjIjoiYmMwMDM0MGQzMTMxNTViYWMwZDEwZjNiZjNjZDJlZTRjZDUyNzdmMTc3ZDJmNWUyOTQ3NTM4OTIzMGI5NTM2MyJ9; 121ffe2b1506d0e1840564b4fd65594ac87733d9=eyJpdiI6ImZvZWpsSUJkV3FKbm9LZGl5R0I5UkE9PSIsInZhbHVlIjoiaVhMVXAyTUpTcnNpaTVuZ3lrYWhnOHJNbVRvSDZEZ2hqdit1V3Frb0I5ZDlNd2xxdmM1dVcydUtcL0NvbDMxRWhqK1NvakJaaGdwRlwvU2o1NlZmTEM5VGlMOWE0eWJuXC9Nb3dXbUlNdzQxOWRWblRuMGZmYmRcLzlWeUFhbGdleWdLZSs1NFFjUnVNcW5cLytwUjFuR2NXZlBcL1c0T0daOEhzZkxxTUxYcVV3bnZ5MFJLSmpHbzFPSkx0VG4zaUZpb1I0dUUyXC9RM25OazRnREtSWDJ1T25MZytEODVKMmplN2h1Q1poczhyMVNTRmJBMjlcL0lJS2ZIVWlFWkUyclJwbDU5SkZEN0VqanVTeElkd2h4SGpuS2JoaFNLb0xZRHhrUitDOFdMb0JsclB1d0lGMGpWcFwvOXhmOXFkVlM2YXowaXNnY09ESnJ5Y0U5V0txQjFGemxGdXpocTlwYjdOXC9qdUk4ZG9FTldUeTMydnBtWmZVWlVxRmdHYUJsNVdGd3VyM3BIb2VpMFBoQ1ZQQ1pYbHhOWVlmSTIxV1hSR09mRks3Z3duM2FiTWlEdGN1cmRwYjI3K1dEMEpRZzhsYXRcL1lrbjFkSXRyOVhGWHNCWEJ0ZFBmdVE5UT09IiwibWFjIjoiZGJmNTIzNDFmYzc1OGIyY2Y5MDZmODAyNDZkM2Y1YWE0ZjM3YmMyMGVmZTQzOWNlZTEzY2E4NjFjODMwNzcxYyJ9",
		"Host: www.jne.co.id",
		"Postman-Token: 6cf0b9d6-f98c-4072-89d8-8944a80247da,73b19e61-92cc-447d-977f-12439da27f58",
		"Referer: https://www.jne.co.id/id/beranda",
		"User-Agent: Mozilla/5.0 (Windows NT 6.1; Win64; x64; rv:69.0) Gecko/20100101 Firefox/69.0",
		"X-Requested-With: XMLHttpRequest",
		"cache-control: no-cache"
	  ),
	));
	
	
	$result = curl_exec($curl);
	$err = curl_error($curl);
	curl_close($curl);
	
	if(!$err && isJson($result)){
		$stts = 'valid';
		valid($result);
	}else{
		$stts = 'invalid';
		invalid($keyword);
	}
	
	$response = array(
		'status' => $stts
	);
	
	$response=json_encode($response);
	
	echo $response;
}


function error(){
	$error=array(
		'status' => 'invalid'
	);
	$response = json_encode($error);
	return $response;
}

function isJson($string) {
	json_decode($string);
	return (json_last_error() == JSON_ERROR_NONE);
}

function valid($result){
	$file = 'output/result_'.date('Y-m-d').'.txt';
	$data = json_decode($result,true);	
	$data = $data['suggestions'];
	
	for ($i = 0; $i < count($data); $i++){
		$city_name = $data[$i]['value'];
		$city_name = str_replace("'","\'",$city_name);
		$text = "('".$data[$i]['code']."','".$city_name."'),";
		file_put_contents($file, $text.PHP_EOL , FILE_APPEND | LOCK_EX);
	}
}

function invalid($text){
	$file = 'invalid/result_'.date('Y-m-d').'.txt';
	file_put_contents($file, $text.PHP_EOL , FILE_APPEND | LOCK_EX);
}



